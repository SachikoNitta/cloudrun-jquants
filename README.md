# Flask アプリケーション(タイトル未定) 🚀✨

このプロジェクトは、Flask を使ってj-Quantsから取得したデータをGCP上に保存するためのシンプルなアプリだよ🌟

## 必要条件 ✅

- Python 3.8 以上 🐍
- Docker (オプション) 🐳

## 環境変数 🌐🔧

アプリで使う環境変数を設定するために、`.env`ファイルを作ってね！📝

- `JQUANTS_EMAIL`: J-Quants API にアクセスするためのメールアドレス（リフレッシュトークンを取得する時に使うよ）。📧
- `JQUANTS_PASSWORD`: J-Quants API にアクセスするためのパスワードだよ。🔒
- `FIRESTORE_DB_NAME`:（オプション）`.../store`というURLのAPIルートでFireStoreにデータを保存する場合使用するデータベースの名前だよ。

ローカルで実行する場合は、`.env.sample`ファイルを参考にして、`.env`ファイルを作ってね！📄

Cloud Run上で実行する場合は、Console上で設定することもできるよ！☁️✨

## アプリの実行方法

### ローカルを使った方法

このプロジェクトでは、Python の仮想環境を使って依存関係を管理してるよ！以下の手順に従って、仮想環境をセットアップしてみてね！🚀
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python app.py
```
ここまで実行したらブラウザでアクセスできるよ！🕺✨
```
http://localhost:8081
```
実行し終わったら仮想環境を無効化してね！
```
deactivate
```

### Docker を使った方法 🐋⚡

1. Docker イメージをビルドするよ！🔨
   ```bash
   docker build -t flask-app .
   ```

2. Docker コンテナを起動！🎯
   ```bash
   docker run -p 8081:8081 flask-app
   ```

3. ブラウザで以下の URL にアクセスしてみて！🌍
   ```
   http://localhost:8081
   ```

### Cloud Run上を使った方法
このリポジトリをForkしたものを「リポジトリを接続」から接続するか、ローカルから`gcloud run deploy`コマンドでデプロイしてね！☝️🕊️

#### Cloud Run にデプロイするときの注意点 🚀⚠️

Cloud Run にデプロイする際には、以下の点に注意してね！

##### 認証が必要な設定について 🔒

Cloud Run では、デフォルトで受信リクエストを認証するように設定されているよ。この設定を維持すると、インターネットに公開されない代わりに、リクエスト時に Bearer トークンが必要になるんだ。

##### Bearer トークンを使ったリクエストの例 🌐

以下のコマンドを使って、認証付きでリクエストを送信できるよ：

```bash
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
     https://[Cloud RunのエンドポイントURL]/listed/info
```

この例では、上場銘柄の一部を取得するエンドポイントにアクセスしているよ！📈

##### 認証を不要にする場合 🌍

もし認証を不要にして、誰でもアクセスできるようにしたい場合は、以下の手順を実行してね：

1. **Google Cloud Console にログイン**
2. **Cloud Run のサービスを選択**
3. **セキュリティタブを開く**
   - 「Cloud IAM を使用して受信リクエストを認証する」のチェックをはずす
4. **変更を保存**

これで、認証なしでリクエストを受け付けるようになるよ！ただし、セキュリティには注意してね！⚠️

## ファイル構成 📂🗂️

- `app.py`: Flask アプリのメインスクリプトだよ！📝
- `requirements.txt`: 必要な Python パッケージが書いてあるファイル。📋
- `Dockerfile`: Docker イメージを作るための設定ファイル。🐋

## エンドポイント 🌟🔗

このアプリでは、以下のエンドポイントが使えるよ！🎉

### `/`
- **説明**: アプリの動作確認用のエンドポイントだよ！
- **HTTP メソッド**: GET
- **レスポンス**: `Hello, World!` 🌍✨

### `/token/auth_user`
- **説明**: J-Quants API のリフレッシュトークンを取得するよ！🔑
- **HTTP メソッド**: GET
- **レスポンス**: リフレッシュトークンを含む JSON オブジェクト。📦

### `/token/auth_refresh`
- **説明**: リフレッシュトークンを使って ID トークンを取得するよ！🆔
- **HTTP メソッド**: GET
- **レスポンス**: ID トークンを含む JSON オブジェクト。📄

### `/listed/info`
- **説明**: 上場銘柄の一覧情報を取得するよ！📈  
  このエンドポイントは内部で `/token/auth_refresh` と `/token/auth_user` を呼び出しているから、直接アクセスするだけで大丈夫だよ！🔄✨
- **HTTP メソッド**: GET
- **レスポンス**: 上場銘柄情報を含む JSON オブジェクト。💹

### `/listed/info/store`（RESTにするか考え中だよ）
- **説明**: 上場銘柄の一覧情報をFireStoreに保存するよ！📥  
- **HTTP メソッド**: GET

## 注意事項 ⚠️🚨

- アプリはデフォルトでポート `8081` で動くよ。他のアプリとポートが競合しないように気をつけてね！⚙️
- Docker を使う場合、Docker がインストールされてるか確認してね！🐳

## ライセンス 📜✨

このプロジェクトは MIT ライセンスだよ！自由に使ってね！🎉