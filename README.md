# Flask アプリケーション 🚀✨

このプロジェクトは、Flask を使って作ったシンプルなウェブアプリだよ！🌟

## 必要条件 ✅

- Python 3.8 以上 🐍
- pip (Python パッケージマネージャ) 📦
- Docker (オプション) 🐳

## セットアップと実行方法 🛠️💡

### 1. ローカル環境での実行 💻🎉

1. 必要なパッケージをインストールするよ！📥
   ```bash
   pip install -r requirements.txt
   ```

2. アプリケーションを起動！🚀
   ```bash
   python app.py
   ```

3. ブラウザで以下の URL にアクセスしてね！🌐
   ```
   http://localhost:8081
   ```

### 2. Docker を使った実行 🐋⚡

1. Docker イメージをビルドするよ！🔨
   ```bash
   docker build -t flask-app .
   ```

2. Docker コンテナを起動！🎯
   ```bash
   docker run -p 8081:8081 flask-app
   ```

3. ブラウザで以下の URL にアクセスしてみて！🌍
   ```
   http://localhost:8081
   ```

## 環境変数 🌐🔧

アプリで使う環境変数を設定するために、`.env`ファイルを作ってね！📝

- `JQUANTS_EMAIL`: J-Quants API にアクセスするためのメールアドレス（リフレッシュトークンを取得する時に使うよ）。📧
- `JQUANTS_PASSWORD`: J-Quants API にアクセスするためのパスワード。🔒

ローカルで実行する場合は、`.env.sample`ファイルを参考にして、`.env`ファイルを作ってね！📄

Cloud Run上で実行する場合は、Console上で設定することもできるよ！☁️✨

## ファイル構成 📂🗂️

- `app.py`: Flask アプリのメインスクリプトだよ！📝
- `requirements.txt`: 必要な Python パッケージが書いてあるファイル。📋
- `Dockerfile`: Docker イメージを作るための設定ファイル。🐋

## エンドポイント 🌟🔗

このアプリでは、以下のエンドポイントが使えるよ！🎉

### `/`
- **説明**: アプリの動作確認用のエンドポイントだよ！
- **HTTP メソッド**: GET
- **レスポンス**: `Hello, World!` 🌍✨

### `/token/auth_user`
- **説明**: J-Quants API のリフレッシュトークンを取得するよ！🔑
- **HTTP メソッド**: GET
- **レスポンス**: リフレッシュトークンを含む JSON オブジェクト。📦

### `/token/auth_refresh`
- **説明**: リフレッシュトークンを使って ID トークンを取得するよ！🆔
- **HTTP メソッド**: GET
- **レスポンス**: ID トークンを含む JSON オブジェクト。📄

### `/listed/info`
- **説明**: 上場銘柄の一覧情報を取得するよ！📈  
  このエンドポイントは内部で `/token/auth_refresh` と `/token/auth_user` を呼び出しているから、直接アクセスするだけで大丈夫だよ！🔄✨
- **HTTP メソッド**: GET
- **レスポンス**: 上場銘柄情報を含む JSON オブジェクト。💹

## Cloud Run にデプロイするときの注意点 🚀⚠️

Cloud Run にデプロイする際には、以下の点に注意してね！

### 認証が必要な設定について 🔒

Cloud Run では、デフォルトで受信リクエストを認証するように設定されているよ。この設定を維持すると、インターネットに公開されない代わりに、リクエスト時に Bearer トークンが必要になるんだ。

#### Bearer トークンを使ったリクエストの例 🌐

以下のコマンドを使って、認証付きでリクエストを送信できるよ：

```bash
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
     https://[Cloud RunのエンドポイントURL]/listed/info
```

この例では、上場銘柄の一部を取得するエンドポイントにアクセスしているよ！📈

### 認証を不要にする場合 🌍

もし認証を不要にして、誰でもアクセスできるようにしたい場合は、以下の手順を実行してね：

1. **Google Cloud Console にログイン**
2. **Cloud Run のサービスを選択**
3. **セキュリティタブを開く**
   - 「Cloud IAM を使用して受信リクエストを認証する」のチェックをはずす
4. **変更を保存**

これで、認証なしでリクエストを受け付けるようになるよ！ただし、セキュリティには注意してね！⚠️

## 注意事項 ⚠️🚨

- アプリはデフォルトでポート `8081` で動くよ。他のアプリとポートが競合しないように気をつけてね！⚙️
- Docker を使う場合、Docker がインストールされてるか確認してね！🐳

## ライセンス 📜✨

このプロジェクトは MIT ライセンスだよ！自由に使ってね！🎉